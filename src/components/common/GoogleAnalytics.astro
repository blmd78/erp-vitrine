---
import { metricsLogger } from '@/lib/logging/index'

interface Props {
	debugMode?: boolean
}

const { debugMode = false } = Astro.props
const gaId = import.meta.env.GA_MEASUREMENT_ID || process.env.GA_MEASUREMENT_ID

// Early return si pas de GA ID
if (!gaId) {
	metricsLogger.info(
		'No Google Analytics ID provided - skipping GA initialization',
	)
	return null
}

// Validation sécurisée du Google Analytics ID
const GA_ID_PATTERN = /^G-[A-Z0-9]{10}$/
const isValidGaId = (id: string): boolean => GA_ID_PATTERN.test(id)

if (!isValidGaId(gaId)) {
	metricsLogger.warn('Invalid Google Analytics ID format:', {
		details: { gaId },
	})
	return null
}

const shouldLoadGA = import.meta.env.PROD || debugMode

// Script sécurisé avec validation
const analyticsScript = `
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '${gaId}', {
	page_title: document.title,
	page_location: window.location.href,
	send_page_view: true,
	anonymize_ip: true,
	allow_google_signals: true,
	allow_ad_personalization_signals: false
});

// Liste des événements autorisés pour la sécurité
const ALLOWED_EVENTS = [
	'contact_form_submit',
	'quote_request',
	'project_start',
	'pricing_view',
	'workflow_step_view',
	'local_interaction'
];

window.gtag_nextnode = {
	trackContactForm: function(type) {
		gtag('event', 'contact_form_submit', {
			event_category: 'conversion',
			event_label: type || 'general',
			value: 1,
			location_type: 'paris',
			service_area: 'ile_de_france'
		});
	},
	trackQuoteRequest: function(type) {
		gtag('event', 'quote_request', {
			event_category: 'lead_generation',
			event_label: type || 'website',
			value: 5,
			currency: 'EUR',
			location_type: 'paris'
		});
	},
	trackProjectStart: function(type) {
		gtag('event', 'project_start', {
			event_category: 'conversion',
			event_label: type || 'business',
			value: 10,
			currency: 'EUR'
		});
	},
	trackPricingView: function(plan) {
		gtag('event', 'pricing_view', {
			event_category: 'engagement',
			event_label: plan || 'all',
			service_area: 'paris_idf'
		});
	},
	trackWorkflowStep: function(step) {
		gtag('event', 'workflow_step_view', {
			event_category: 'engagement',
			event_label: 'step_' + step,
			value: step
		});
	},
	trackLocalInteraction: function(type) {
		gtag('event', 'local_interaction', {
			event_category: 'local_seo',
			event_label: type,
			location_type: 'paris',
			service_area: 'ile_de_france'
		});
	}
};

// Auto-tracking sécurisé avec validation
document.addEventListener('click', function(e) {
	var el = e.target.closest('[data-ga-event]');
	if (el) {
		var eventName = el.getAttribute('data-ga-event');
		var eventCategory = el.getAttribute('data-ga-category') || 'interaction';
		var eventLabel = el.getAttribute('data-ga-label') || '';

		// Validation de sécurité : seuls les événements autorisés
		if (ALLOWED_EVENTS.includes(eventName)) {
			gtag('event', eventName, {
				event_category: eventCategory,
				event_label: eventLabel
			});
		}
	}
});
`

const debugScript = `
window.gtag_nextnode = {
	trackContactForm: function() {},
	trackQuoteRequest: function() {},
	trackProjectStart: function() {},
	trackPricingView: function() {},
	trackWorkflowStep: function() {},
	trackLocalInteraction: function() {}
};
`
---

{
	shouldLoadGA ? (
		<>
			<script
				async
				src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}
				is:inline
			/>
			<script is:inline set:html={analyticsScript} />
		</>
	) : (
		<script is:inline set:html={debugScript} />
	)
}
